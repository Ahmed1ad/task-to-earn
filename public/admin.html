<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | Task to Earn</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        primary: '#4F46E5', // Indigo-600
                        secondary: '#10B981', // Emerald-500
                        danger: '#EF4444' // Red-500
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar-active {
            background-color: rgba(79, 70, 229, 0.1);
            color: #4F46E5;
            border-right: 3px solid #4F46E5;
        }

        body {
            background-color: #F3F4F6;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94A3B8;
        }
    </style>
</head>

<body class="text-gray-800">

    <!-- Login Modal -->
    <div id="login-modal"
        class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl relative">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">تسجيل دخول المشرف</h2>
            <form onsubmit="event.preventDefault(); login();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                        <input type="email" id="login-email"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition"
                            required placeholder="admin@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                        <input type="password" id="login-password"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition"
                            required placeholder="••••••••">
                    </div>
                    <button type="submit"
                        class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg active:scale-95">
                        دخول للوحة التحكم
                    </button>
                    <p id="login-error" class="text-red-500 text-center text-sm font-bold mt-2"></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Layout -->
    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside class="w-72 bg-white border-l border-gray-100 hidden md:flex flex-col z-20 shadow-xl">
            <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-indigo-100 text-primary flex items-center justify-center">
                    <i class="fas fa-shield-alt text-xl"></i>
                </div>
                <div>
                    <h1 class="font-black text-lg text-gray-800 tracking-tight">لوحة الإدارة</h1>
                    <p class="text-xs text-gray-400 font-semibold">System Admin v2.0</p>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="showSection('stats')" id="nav-stats"
                    class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition font-bold sidebar-active">
                    <i class="fas fa-chart-pie w-5"></i> الإحصائيات
                </button>
                <button onclick="showSection('tasks')" id="nav-tasks"
                    class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition font-bold">
                    <i class="fas fa-tasks w-5"></i> إدارة المهام
                </button>
                <button onclick="showSection('proofs')" id="nav-proofs"
                    class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition font-bold">
                    <i class="fas fa-check-circle w-5"></i> مراجعة الإثباتات
                    <span id="proofs-badge"
                        class="mr-auto bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="showSection('withdrawals')" id="nav-withdrawals"
                    class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition font-bold">
                    <i class="fas fa-wallet w-5"></i> طلبات السحب
                    <span id="withdrawals-badge"
                        class="mr-auto bg-amber-100 text-amber-600 text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="showSection('users')" id="nav-users"
                    class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition font-bold">
                    <i class="fas fa-users w-5"></i> المستخدمين
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <button onclick="logout()"
                    class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-red-50 text-red-600 hover:bg-red-100 font-bold transition">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto relative">
            <header
                class="bg-white border-b border-gray-100 h-16 flex items-center justify-between px-6 sticky top-0 z-10">
                <h2 class="font-bold text-xl text-gray-800" id="page-title">نظرة عامة</h2>
                <div class="text-sm font-semibold text-gray-500 bg-gray-50 px-3 py-1 rounded-lg">
                    Admin Access
                </div>
            </header>

            <div class="p-6 max-w-7xl mx-auto space-y-6">

                <!-- STATS SECTION -->
                <div id="section-stats" class="content-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div
                                class="w-14 h-14 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-2xl">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400 font-bold">إجمالي المستخدمين</p>
                                <p class="text-2xl font-black text-gray-800" id="stat-users">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div
                                class="w-14 h-14 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center text-2xl">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400 font-bold">مهام مكتملة</p>
                                <p class="text-2xl font-black text-gray-800" id="stat-points">0</p>
                                <p class="text-xs text-gray-400">نقطة موزعة</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div
                                class="w-14 h-14 rounded-full bg-amber-50 text-amber-600 flex items-center justify-center text-2xl">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400 font-bold">سحوبات معلقة</p>
                                <p class="text-2xl font-black text-gray-800" id="stat-withdrawals">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div
                                class="w-14 h-14 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center text-2xl">
                                <i class="fas fa-file-image"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400 font-bold">إثباتات للمراجعة</p>
                                <p class="text-2xl font-black text-gray-800" id="stat-proofs">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- USERS SECTION -->
                <div id="section-users" class="content-section hidden space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="flex-1 relative">
                                <i class="fas fa-search absolute right-4 top-3.5 text-gray-400"></i>
                                <input type="text" id="user-search"
                                    placeholder="بحث باسم المستخدم أو البريد الإلكتروني..."
                                    class="w-full pr-10 pl-4 py-3 rounded-xl border border-gray-200 outline-none focus:border-primary">
                            </div>
                            <button onclick="loadUsers()"
                                class="px-6 py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-gray-800">بحث</button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-right" id="users-table">
                                <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold">
                                    <tr>
                                        <th class="p-4 rounded-r-xl">ID</th>
                                        <th class="p-4">المستخدم</th>
                                        <th class="p-4">النقاط</th>
                                        <th class="p-4">الحالة</th>
                                        <th class="p-4">IP</th>
                                        <th class="p-4 rounded-l-xl">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50 text-sm font-semibold text-gray-700">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TASKS SECTION -->
                <div id="section-tasks" class="content-section hidden space-y-6">
                    <div class="flex justify-end">
                        <button onclick="openTaskModal()"
                            class="flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">
                            <i class="fas fa-plus"></i> مهمة جديدة
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="w-full text-right" id="tasks-table">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4">نوع المهمة</th>
                                    <th class="p-4">العنوان</th>
                                    <th class="p-4">المكافأة</th>
                                    <th class="p-4">المتطلبات</th>
                                    <th class="p-4">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50 text-sm font-semibold text-gray-700">
                                <!-- Populated JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- PROOFS SECTION -->
                <div id="section-proofs" class="content-section hidden space-y-6">
                    <div id="proofs-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Populated JS -->
                    </div>
                    <div id="no-proofs" class="hidden text-center py-20 text-gray-400">
                        <i class="fas fa-check-circle text-6xl mb-4 opacity-20"></i>
                        <p class="font-bold">لا توجد إثباتات معلقة للمراجعة</p>
                    </div>
                </div>

                <!-- WITHDRAWALS SECTION -->
                <div id="section-withdrawals" class="content-section hidden space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="w-full text-right" id="withdrawals-table">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4">المستخدم</th>
                                    <th class="p-4">المبلغ</th>
                                    <th class="p-4">بطاقة / محفظة</th>
                                    <th class="p-4">الحالة</th>
                                    <th class="p-4">التاريخ</th>
                                    <th class="p-4">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50 text-sm font-semibold text-gray-700">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add Task Modal -->
    <div id="task-modal"
        class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl animate-scale-in">
            <h3 class="text-xl font-bold mb-4">إضافة مهمة جديدة</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">نوع المهمة</label>
                        <select id="new-task-type"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:border-primary mt-1"
                            onchange="toggleTaskFields()">
                            <option value="auto">تلقائي (مشاهدة)</option>
                            <option value="manual">يدوي (رفع إثبات)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">عدد النقاط</label>
                        <input type="number" id="new-task-points"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:border-primary mt-1"
                            placeholder="مثال: 50">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">عنوان المهمة</label>
                    <input type="text" id="new-task-title"
                        class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:border-primary mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">وصف المهمة</label>
                    <textarea id="new-task-desc"
                        class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:border-primary mt-1"
                        rows="2"></textarea>
                </div>

                <!-- Variable Fields -->
                <div id="field-url">
                    <label class="text-xs font-bold text-gray-500 uppercase">رابط المهمة / الإعلان (مطلوب)</label>
                    <input type="text" id="new-task-url"
                        class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:border-primary mt-1"
                        placeholder="https://...">
                </div>
                <div id="field-duration">
                    <label class="text-xs font-bold text-gray-500 uppercase">المدة / الثواني (مطلوب)</label>
                    <input type="number" id="new-task-duration"
                        class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:border-primary mt-1"
                        value="30">
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="document.getElementById('task-modal').classList.add('hidden')"
                        class="px-4 py-2 rounded-xl font-bold text-gray-500 hover:bg-gray-100">إلغاء</button>
                    <button onclick="createTask()"
                        class="px-6 py-2 rounded-xl bg-primary text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">حفظ
                        ونشر</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Point Edit Modal -->
    <div id="points-modal"
        class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-scale-in">
            <h3 class="text-xl font-bold mb-4">تعديل رصيد المستخدم</h3>
            <input type="hidden" id="edit-user-id">
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">عدد النقاط (سالب للخصم)</label>
                    <input type="number" id="edit-points-val"
                        class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:border-primary mt-1"
                        placeholder="مثال: 100 أو -50">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">السبب</label>
                    <input type="text" id="edit-points-reason"
                        class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:border-primary mt-1"
                        placeholder="مكافأة، خصم مخالفة...">
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button onclick="document.getElementById('points-modal').classList.add('hidden')"
                        class="px-4 py-2 rounded-xl font-bold text-gray-500 hover:bg-gray-100">إلغاء</button>
                    <button onclick="submitPointEdit()"
                        class="px-6 py-2 rounded-xl bg-primary text-white font-bold hover:bg-indigo-700">تحديث</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ================= LOGIC ================= */
        const API_URL = '';
        let token = localStorage.getItem('token');
        let currentSection = 'stats';

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${id}`).classList.remove('hidden');

            document.querySelectorAll('nav button').forEach(el => el.classList.remove('sidebar-active', 'bg-indigo-50', 'text-primary'));
            const btn = document.getElementById(`nav-${id}`);
            if (btn) btn.classList.add('sidebar-active');

            const titles = { stats: 'الإحصائيات العامة', tasks: 'إدارة المهام', proofs: 'مراجعة الإثباتات', withdrawals: 'طلبات السحب', users: 'إدارة المستخدمين' };
            document.getElementById('page-title').innerText = titles[id] || 'لوحة التحكم';

            currentSection = id;
            loadDataForSection(id);
        }

        async function loadDataForSection(id) {
            if (id === 'stats') loadStats();
            if (id === 'users') loadUsers();
            if (id === 'tasks') loadTasks();
            if (id === 'withdrawals') loadWithdrawals();
            if (id === 'proofs') loadProofs();
        }

        /* --- AUTH --- */
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errEl = document.getElementById('login-error');
            errEl.innerText = '';

            try {
                const res = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    token = data.token;
                    localStorage.setItem('token', token);
                    document.getElementById('login-modal').classList.add('hidden');
                    loadStats();
                } else {
                    errEl.innerText = data.message || 'فشل الدخول';
                }
            } catch (e) { errEl.innerText = 'خطأ اتصال'; }
        }

        // Auto check
        (async function init() {
            if (!token) {
                document.getElementById('login-modal').classList.remove('hidden');
            } else {
                // Verify token validity quickly
                try {
                    const res = await fetch('/admin/stats', { headers: { Authorization: `Bearer ${token}` } });
                    if (res.status === 401 || res.status === 403) {
                        localStorage.removeItem('token');
                        location.reload();
                    } else {
                        loadStats();
                    }
                } catch (e) { }
            }
        })();

        /* --- API HELPERS --- */
        async function fetchAuth(endpoint, options = {}) {
            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            const res = await fetch(endpoint, options);
            if (res.status === 401 || res.status === 403) {
                localStorage.removeItem('token');
                location.reload();
                return null;
            }
            return res.json();
        }

        function logout() { localStorage.removeItem('token'); location.reload(); }

        /* --- LOADERS --- */
        async function loadStats() {
            const data = await fetchAuth('/admin/stats');
            if (data && data.stats) {
                document.getElementById('stat-users').innerText = data.stats.total_users;
                document.getElementById('stat-points').innerText = data.stats.total_points_distributed;
                document.getElementById('stat-withdrawals').innerText = data.stats.pending_withdrawals;
                document.getElementById('stat-proofs').innerText = data.stats.pending_proofs;

                // Update Badges
                if (data.stats.pending_proofs > 0) {
                    const b = document.getElementById('proofs-badge');
                    b.innerText = data.stats.pending_proofs;
                    b.classList.remove('hidden');
                }
                if (data.stats.pending_withdrawals > 0) {
                    const b = document.getElementById('withdrawals-badge');
                    b.innerText = data.stats.pending_withdrawals;
                    b.classList.remove('hidden');
                }
            }
        }

        async function loadUsers() {
            const search = document.getElementById('user-search').value;
            const url = search ? `/admin/users?search=${encodeURIComponent(search)}` : '/admin/users';
            const data = await fetchAuth(url);

            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';

            if (data && data.users) {
                data.users.forEach(u => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="p-4 rounded-r-xl text-gray-400 font-mono">#${u.id}</td>
                            <td class="p-4">
                                <p class="font-bold text-gray-900">${u.username}</p>
                                <p class="text-xs text-gray-400">${u.email}</p>
                            </td>
                            <td class="p-4 font-bold text-secondary">${u.points}</td>
                            <td class="p-4">
                                ${u.is_banned
                            ? '<span class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs font-bold">محظور</span>'
                            : '<span class="px-2 py-1 bg-green-100 text-green-600 rounded text-xs font-bold">نشط</span>'}
                            </td>
                            <td class="p-4 text-xs font-mono text-gray-400">${u.last_ip || '-'}</td>
                            <td class="p-4 rounded-l-xl flex gap-2">
                                <button onclick="openPointsModal(${u.id})" class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100" title="تعديل النقاط"><i class="fas fa-coins"></i></button>
                                ${u.is_banned
                            ? `<button onclick="toggleBan(${u.id}, 'unban')" class="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100" title="فك الحظر"><i class="fas fa-unlock"></i></button>`
                            : `<button onclick="toggleBan(${u.id}, 'ban')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100" title="حظر"><i class="fas fa-ban"></i></button>`
                        }
                            </td>
                        </tr>
                    `;
                });
            }
        }

        async function loadTasks() {
            const data = await fetchAuth('/admin/tasks');
            const tbody = document.querySelector('#tasks-table tbody');
            tbody.innerHTML = '';

            if (data && data.tasks) {
                data.tasks.forEach(t => {
                    const isAuto = t.task_type === 'auto' || !t.task_type;
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="p-4">
                                <span class="px-2 py-1 rounded text-xs font-bold ${isAuto ? 'bg-blue-100 text-blue-600' : 'bg-purple-100 text-purple-600'}">
                                    ${isAuto ? 'تلقائي' : 'يدوي'}
                                </span>
                            </td>
                            <td class="p-4 font-bold text-gray-800">${t.title}</td>
                            <td class="p-4 font-bold text-secondary">+${t.reward_points}</td>
                            <td class="p-4 text-xs text-gray-500 max-w-xs truncate">
                                ${isAuto ? `Duration: ${t.duration_seconds}s` : 'Proof Image'}
                            </td>
                            <td class="p-4">
                                <button onclick="deleteTask(${t.id})" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
        }

        async function loadWithdrawals() {
            const data = await fetchAuth('/admin/withdrawals');
            const tbody = document.querySelector('#withdrawals-table tbody');
            tbody.innerHTML = '';

            if (data && data.withdrawals) {
                data.withdrawals.forEach(w => {
                    const statusColors = { pending: 'bg-amber-100 text-amber-700', approved: 'bg-green-100 text-green-700', rejected: 'bg-red-100 text-red-700' };
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="p-4 font-bold">${w.username}</td>
                            <td class="p-4 font-black text-gray-800">${w.amount_points}</td>
                            <td class="p-4 text-xs">
                                <div class="font-bold text-gray-700">${w.method}</div>
                                <div class="text-gray-400 font-mono">${w.wallet_or_number}</div>
                            </td>
                            <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColors[w.status] || 'bg-gray-100'}">${w.status}</span></td>
                            <td class="p-4 text-xs text-gray-400">${new Date(w.created_at).toLocaleDateString()}</td>
                            <td class="p-4 flex gap-2">
                                ${w.status === 'pending' ? `
                                    <button onclick="actionWithdrawal(${w.id}, 'approve')" class="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100"><i class="fas fa-check"></i></button>
                                    <button onclick="actionWithdrawal(${w.id}, 'reject')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100"><i class="fas fa-times"></i></button>
                                ` : '<span class="text-gray-300">-</span>'}
                            </td>
                        </tr>
                    `;
                });
            }
        }

        async function loadProofs() {
            const data = await fetchAuth('/admin/manual-tasks/pending');
            const container = document.getElementById('proofs-container');
            const empty = document.getElementById('no-proofs');

            container.innerHTML = '';

            if (!data.proofs || data.proofs.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            data.proofs.forEach(p => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-3">
                        <div class="flex items-center justify-between pb-2 border-b border-gray-50">
                            <div>
                                <p class="font-bold text-sm text-gray-800">${p.username}</p>
                                <p class="text-xs text-gray-400">Task: ${p.task_title}</p>
                            </div>
                            <span class="font-black text-secondary text-lg">+${p.reward_points}</span>
                        </div>
                        <div class="aspect-video rounded-lg overflow-hidden bg-gray-100 border border-gray-200">
                            <a href="${p.image_url}" target="_blank">
                                <img src="${p.image_url}" class="w-full h-full object-cover hover:scale-105 transition duration-500 cursor-zoom-in">
                            </a>
                        </div>
                        <div class="flex gap-2 mt-auto pt-2">
                            <button onclick="actionProof(${p.id}, 'approve')" class="flex-1 py-2 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 shadow transition">قبول</button>
                            <button onclick="actionProof(${p.id}, 'reject')" class="flex-1 py-2 bg-red-100 text-red-600 rounded-lg font-bold hover:bg-red-200 transition">رفض</button>
                        </div>
                    </div>
                `;
            });
        }

        /* --- ACTIONS --- */
        async function toggleTaskFields() {
            // Always show all fields as requested by user
            // But we can update labels or hints if needed
            const type = document.getElementById('new-task-type').value;
            const urlLabel = document.querySelector('#field-url label');

            if (type === 'manual') {
                urlLabel.innerText = "رابط المهمة (مثل قناة تيليجرام)";
                // document.getElementById('field-duration').classList.add('hidden'); // User said duration is required, so keep it
            } else {
                urlLabel.innerText = "رابط الإعلان (Auto Only)";
            }
        }
        function openTaskModal() {
            toggleTaskFields();
            document.getElementById('task-modal').classList.remove('hidden');
        }

        async function createTask() {
            const body = {
                task_type: document.getElementById('new-task-type').value,
                title: document.getElementById('new-task-title').value,
                description: document.getElementById('new-task-desc').value,
                reward_points: document.getElementById('new-task-points').value,
                duration_seconds: document.getElementById('new-task-duration').value,
                ad_url: document.getElementById('new-task-url').value,
            };

            // VALIDATION
            if (!body.title || !body.reward_points || !body.duration_seconds || !body.ad_url) {
                alert('جميع الحقول مطلوبة (العنوان، النقاط، المدة، الرابط)');
                return;
            }

            const res = await fetchAuth('/admin/add-task', { method: 'POST', body: JSON.stringify(body) });
            if (res.status === 'success') {
                document.getElementById('task-modal').classList.add('hidden');
                loadTasks();
            } else alert(res.message);
        }

        async function deleteTask(id) {
            if (!confirm('حذف المهمة؟')) return;
            await fetchAuth(`/admin/delete-task/${id}`, { method: 'DELETE' });
            loadTasks();
        }

        /* USER ACTIONS */
        function openPointsModal(uid) {
            document.getElementById('edit-user-id').value = uid;
            document.getElementById('points-modal').classList.remove('hidden');
        }
        async function submitPointEdit() {
            const uid = document.getElementById('edit-user-id').value;
            const points = document.getElementById('edit-points-val').value;
            const reason = document.getElementById('edit-points-reason').value;

            const res = await fetchAuth(`/admin/users/${uid}/points`, {
                method: 'POST', body: JSON.stringify({ points, reason })
            });
            if (res.status === 'success') {
                document.getElementById('points-modal').classList.add('hidden');
                loadUsers();
            } else alert(res.message);
        }
        async function toggleBan(id, action) {
            if (!confirm('تأكيد الإجراء؟')) return;
            await fetchAuth(`/admin/users/${id}/${action}`, { method: 'POST' });
            loadUsers();
        }

        /* MANAGERS */
        async function actionWithdrawal(id, action) {
            if (!confirm(action === 'approve' ? 'موافقة على السحب؟' : 'رفض السحب؟')) return;
            await fetchAuth(`/admin/withdrawals/${id}/action`, { method: 'POST', body: JSON.stringify({ action }) });
            loadWithdrawals();
            loadStats();
        }

        async function actionProof(id, action) {
            if (!confirm(action === 'approve' ? 'قبول الإثبات ومنح النقاط؟' : 'رفض الإثبات؟')) return;
            await fetchAuth(`/admin/manual-tasks/${id}/action`, { method: 'POST', body: JSON.stringify({ action }) });
            loadProofs();
            loadStats();
        }

    </script>
</body>

</html>
